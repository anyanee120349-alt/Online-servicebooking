<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PetCare Pro - Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; background: #f1f5f9; color: #0f172a; }
        :root { --primary-blue: #1d4ed8; }
        .btn-confirm { background: var(--primary-blue); @apply text-white py-4 px-12 rounded-xl font-bold text-2xl flex items-center justify-center gap-3 transition-all shadow-lg w-full max-w-[450px]; }
        .input-box { @apply w-full p-4 border-2 border-slate-300 rounded-xl focus:ring-4 focus:ring-blue-500/20 focus:border-blue-600 outline-none transition-all bg-white text-xl font-medium text-slate-900; }
        .form-section { @apply mb-10 bg-white rounded-[2rem] overflow-hidden shadow-md border-2 border-slate-100; }
        .form-header { background: #eff6ff; @apply py-5 px-8 text-blue-900 flex items-center gap-3 font-extrabold text-xl border-b-2 border-blue-100; }
        label { @apply block mb-2 text-lg font-bold text-slate-800 ml-1; }
        .page-content { display: none; }
        .page-active { display: block; animation: fadeIn 0.4s ease; }
        .auth-page.page-active { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 85vh; }
        .auth-card { @apply bg-white p-12 rounded-[3rem] shadow-2xl border-2 border-blue-50 w-full max-w-[480px] text-center; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #loader { display: none; position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 9999; flex-direction: column; align-items: center; justify-content: center; }
        .admin-stat-card { @apply bg-white p-8 rounded-[2.5rem] border-b-[10px] shadow-lg text-center; }
    </style>
</head>
<body>

<div id="loader">
    <div class="w-16 h-16 border-8 border-blue-600 border-t-transparent rounded-full animate-spin mb-4"></div>
    <p class="font-bold text-blue-900 text-2xl">กำลังประมวลผล...</p>
</div>

<nav class="bg-white p-6 sticky top-0 z-50 border-b-2 border-slate-200 shadow-sm">
    <div class="max-w-7xl mx-auto flex justify-between items-center">
        <div class="flex items-center gap-2 text-blue-700 font-extrabold text-3xl cursor-pointer" onclick="showPage('booking')">
            <i class="fas fa-paw"></i> PETCARE<span class="text-black">PRO</span>
        </div>
        <div class="flex items-center gap-4">
            <div id="navLinks"></div>
            <button onclick="loginAdmin()" class="bg-slate-800 text-white px-5 py-2 rounded-xl font-bold hover:bg-black transition-all">
                <i class="fas fa-user-shield"></i> เจ้าหน้าที่
            </button>
        </div>
    </div>
</nav>

<div class="max-w-7xl mx-auto px-6 py-12">
    <div id="bookingPage" class="page-content">
        <div id="loginAlert" class="bg-amber-50 border-2 border-amber-200 p-8 rounded-3xl flex items-center justify-between mb-12 shadow-sm">
            <div class="flex items-center gap-5 text-amber-900">
                <i class="fas fa-exclamation-circle text-4xl"></i>
                <div>
                    <h4 class="font-extrabold text-xl">กรุณาเข้าสู่ระบบก่อน</h4>
                    <p class="font-medium">เพื่อดึงข้อมูลสมาชิกและบันทึกประวัติการจอง</p>
                </div>
            </div>
            <button onclick="showPage('login')" class="bg-blue-700 text-white px-10 py-3 rounded-2xl font-bold text-lg hover:bg-blue-800">ล็อกอิน</button>
        </div>

        <form id="bookingForm" class="space-y-8 max-w-5xl mx-auto">
            <div class="form-section">
                <div class="form-header"><i class="fas fa-id-card text-2xl"></i> ข้อมูลผู้จอง</div>
                <div class="p-10 grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div><label>ชื่อเจ้าของ</label><input type="text" id="ownerName" class="input-box bg-slate-100" readonly></div>
                    <div><label>เบอร์โทรศัพท์</label><input type="text" id="ownerTel" class="input-box bg-slate-100" readonly></div>
                </div>
            </div>
            <div class="form-section">
                <div class="form-header"><i class="fas fa-paw text-2xl"></i> ข้อมูลสัตว์เลี้ยง</div>
                <div class="p-10 grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div><label>ชื่อสัตว์เลี้ยง</label><input type="text" name="petName" class="input-box" required></div>
                    <div><label>ชนิดสัตว์</label><select name="petType" class="input-box"><option>สุนัข</option><option>แมว</option><option>อื่นๆ</option></select></div>
                    <div><label>สายพันธุ์</label><input type="text" name="petBreed" class="input-box"></div>
                </div>
            </div>
            <div class="form-section">
                <div class="form-header"><i class="fas fa-calendar-check text-2xl"></i> รายละเอียดนัดหมาย</div>
                <div class="p-10 space-y-8">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <div><label>บริการ</label><select name="serviceType" class="input-box"><option>ตรวจโรคทั่วไป</option><option>ทำวัคซีน</option><option>ตรวจเลือด</option></select></div>
                        <div><label>วันที่</label><input type="date" name="bookingDate" class="input-box" required></div>
                        <div><label>ช่วงเวลา</label><select name="bookingTime" class="input-box"><option>ช่วงเช้า (09:00 - 12:00)</option><option>ช่วงบ่าย (13:00 - 17:00)</option></select></div>
                    </div>
                    <div><label>อาการที่พบ</label><textarea name="symptoms" class="input-box" rows="3"></textarea></div>
                </div>
            </div>
            <center><button type="submit" id="submitBtn" disabled class="btn-confirm">ยืนยันนัดหมาย <i class="fas fa-check"></i></button></center>
        </form>
    </div>

    <div id="adminPage" class="page-content">
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-3xl font-black">รายการจองทั้งหมด</h2>
            <button onclick="loadAdminData()" class="bg-blue-600 text-white px-6 py-2 rounded-xl font-bold"><i class="fas fa-sync"></i> รีเฟรช</button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 text-center">
            <div class="admin-stat-card border-blue-600"><p>ทั้งหมด</p><h3 id="statTotal" class="text-4xl font-bold">0</h3></div>
            <div class="admin-stat-card border-orange-500"><p>รอยืนยัน</p><h3 id="statPending" class="text-4xl font-bold text-orange-600">0</h3></div>
            <div class="admin-stat-card border-green-600"><p>ยืนยันแล้ว</p><h3 id="statConfirmed" class="text-4xl font-bold text-green-600">0</h3></div>
        </div>
        <div class="bg-white rounded-3xl shadow-xl overflow-hidden">
            <table class="w-full text-left">
                <thead class="bg-slate-800 text-white">
                    <tr><th class="p-5">วัน-เวลา</th><th class="p-5">ลูกค้า/สัตว์เลี้ยง</th><th class="p-5">สถานะ</th><th class="p-5 text-center">จัดการ</th></tr>
                </thead>
                <tbody id="adminTableBody"></tbody>
            </table>
        </div>
    </div>

    <div id="loginPage" class="page-content auth-page">
        <div class="auth-card">
            <h2 class="text-3xl font-bold mb-6">เข้าสู่ระบบ</h2>
            <form onsubmit="doLogin(event)" class="space-y-4">
                <input type="tel" id="loginTel" class="input-box text-center" placeholder="เบอร์โทรศัพท์" required>
                <button type="submit" class="w-full bg-blue-700 text-white py-4 rounded-xl font-bold">เข้าสู่ระบบ</button>
            </form>
            <button onclick="showPage('register')" class="mt-4 text-blue-600 font-bold">สมัครสมาชิกใหม่</button>
        </div>
    </div>

    <div id="registerPage" class="page-content auth-page">
        <div class="auth-card text-left">
            <h2 class="text-2xl font-bold mb-6 text-center">สมัครสมาชิก</h2>
            <form onsubmit="doRegister(event)" class="space-y-4">
                <label>ชื่อ-นามสกุล</label><input type="text" id="regName" class="input-box" required>
                <label>เบอร์โทรศัพท์</label><input type="tel" id="regTel" class="input-box" required maxlength="10">
                <button type="submit" class="w-full bg-blue-700 text-white py-4 rounded-xl font-bold mt-4">สมัครสมาชิก</button>
            </form>
        </div>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxQzBg-ywpM-FB7SRqrWVi1k_Ru-eHjv4w2jZhgT4pbud2nevda9grjofMOioGjZsnEgA/exec";

    function showPage(pageId) {
        document.querySelectorAll('.page-content').forEach(p => p.classList.remove('page-active'));
        const target = document.getElementById(pageId + 'Page') || document.getElementById(pageId);
        if(target) target.classList.add('page-active');
        updateUI();
    }

    function toggleLoader(show) { document.getElementById('loader').style.display = show ? 'flex' : 'none'; }

    function updateUI() {
        const user = JSON.parse(localStorage.getItem('petUser'));
        const nav = document.getElementById('navLinks');
        if(user) {
            if(document.getElementById('loginAlert')) document.getElementById('loginAlert').style.display = 'none';
            document.getElementById('submitBtn').disabled = false;
            document.getElementById('ownerName').value = user.name;
            document.getElementById('ownerTel').value = user.tel;
            nav.innerHTML = `<button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-lg font-bold">ออก</button>`;
        } else {
            nav.innerHTML = ``;
        }
    }

    async function doLogin(e) {
        e.preventDefault();
        toggleLoader(true);
        const tel = document.getElementById('loginTel').value;
        try {
            const res = await fetch(SCRIPT_URL);
            const data = await res.json();
            const user = data.find(r => r.OwnerTel == tel && r.BookingId === 'USER_REG');
            if (user) {
                localStorage.setItem('petUser', JSON.stringify({name: user.OwnerName, tel: user.OwnerTel}));
                showPage('booking');
            } else { alert('ไม่พบเบอร์นี้ในระบบ!'); }
        } catch (err) { alert('เชื่อมต่อผิดพลาด'); }
        toggleLoader(false);
    }

    async function doRegister(e) {
        e.preventDefault();
        toggleLoader(true);
        const payload = { action: 'INSERT', BookingId: 'USER_REG', Status: 'Registered', OwnerName: document.getElementById('regName').value, OwnerTel: document.getElementById('regTel').value };
        try {
            await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
            alert('สมัครสำเร็จ!'); showPage('login');
        } catch (err) { alert('สมัครล้มเหลว'); }
        toggleLoader(false);
    }

    document.getElementById('bookingForm').onsubmit = async function(e) {
        e.preventDefault();
        toggleLoader(true);
        const user = JSON.parse(localStorage.getItem('petUser'));
        const formData = new FormData(e.target);
        const payload = { action: 'INSERT', BookingId: 'BK-'+Date.now(), Status: 'รอยืนยัน', OwnerName: user.name, OwnerTel: user.tel, ...Object.fromEntries(formData) };
        try {
            await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
            alert('จองคิวสำเร็จ!'); e.target.reset(); updateUI();
        } catch (err) { alert('ส่งข้อมูลไม่สำเร็จ'); }
        toggleLoader(false);
    };

    function loginAdmin() {
        const pw = prompt("รหัสผ่านเจ้าหน้าที่:");
        if(pw === "1234") { showPage('admin'); loadAdminData(); }
    }

    async function loadAdminData() {
        toggleLoader(true);
        try {
            const res = await fetch(SCRIPT_URL);
            const data = await res.json();
            const bookings = data.filter(d => d.BookingId && d.BookingId.startsWith('BK-')).reverse();
            
            document.getElementById('statTotal').innerText = bookings.length;
            document.getElementById('statPending').innerText = bookings.filter(b => b.Status === 'รอยืนยัน').length;
            document.getElementById('statConfirmed').innerText = bookings.filter(b => b.Status === 'ยืนยันนัดหมายแล้ว').length;

            const tableBody = document.getElementById('adminTableBody');
            tableBody.innerHTML = bookings.map(b => `
                <tr class="border-b">
                    <td class="p-5">${b.bookingDate}<br><small>${b.bookingTime}</small></td>
                    <td class="p-5">${b.OwnerName}<br><small class="text-blue-600">น้อง ${b.petName}</small></td>
                    <td class="p-5">
                        <span class="px-3 py-1 rounded-full text-xs font-bold ${b.Status === 'รอยืนยัน' ? 'bg-orange-100 text-orange-600' : 'bg-green-100 text-green-600'}">
                            ${b.Status}
                        </span>
                    </td>
                    <td class="p-5 text-center">
                        <div class="flex gap-2 justify-center">
                            <a href="tel:${b.OwnerTel}" class="bg-green-500 text-white p-2 rounded-lg"><i class="fas fa-phone"></i></a>
                            ${b.Status === 'รอยืนยัน' ? 
                                `<button onclick="confirmBooking('${b.BookingId}')" class="bg-blue-600 text-white p-2 rounded-lg"><i class="fas fa-check"></i></button>` : 
                                `<button class="bg-slate-200 text-slate-400 p-2 rounded-lg" disabled><i class="fas fa-check-double"></i></button>`
                            }
                            <button onclick="alert('อาการ: ${b.symptoms || "-"}')" class="bg-slate-700 text-white p-2 rounded-lg"><i class="fas fa-info"></i></button>
                        </div>
                    </td>
                </tr>`).join('');
        } catch (e) { alert("โหลดล้มเหลว"); }
        toggleLoader(false);
    }

    async function confirmBooking(id) {
        if(!confirm("ยืนยันคิวนี้ใช่หรือไม่?")) return;
        toggleLoader(true);
        try {
            const payload = { action: 'UPDATE', BookingId: id, Status: 'ยืนยันนัดหมายแล้ว' };
            await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
            alert('ยืนยันสถานะเรียบร้อย!'); loadAdminData(); // โหลดตารางใหม่เพื่อให้สถานะเปลี่ยนทันที
        } catch (err) { alert('ยืนยันล้มเหลว'); }
        toggleLoader(false);
    }

    function logout() { localStorage.removeItem('petUser'); location.reload(); }
    window.onload = () => showPage('booking');
</script>
</body>
</html>
